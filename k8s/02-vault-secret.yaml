---
# This Secret is used by the Vault Agent Injector to authenticate to Vault
apiVersion: v1
kind: Secret
metadata:
  name: vault-auth
  namespace: oracle-nats-publisher
type: Opaque
stringData:
  # This should be created by Vault and contains the service account token
  # In production, this is managed by Vault's Kubernetes auth method
  vault-token: "REPLACE_WITH_VAULT_TOKEN"

---
# ServiceAccount for the application pods to authenticate with Vault
apiVersion: v1
kind: ServiceAccount
metadata:
  name: oracle-nats-publisher
  namespace: oracle-nats-publisher
  annotations:
    # Enable Vault Agent Injector for this service account
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "oracle-nats-publisher"

    # Oracle DB credentials
    vault.hashicorp.com/agent-inject-secret-oracle-credentials: "secret/data/oracle-nats-publisher/oracle-db"
    vault.hashicorp.com/agent-inject-template-oracle-credentials: |
      {{- with secret "secret/data/oracle-nats-publisher/oracle-db" -}}
      export ORACLE_USER="{{ .Data.data.username }}"
      export ORACLE_PASSWORD="{{ .Data.data.password }}"
      export ORACLE_DSN="{{ .Data.data.host }}:{{ .Data.data.port }}/{{ .Data.data.service_name }}"
      {{- end -}}

    # MariaDB credentials
    vault.hashicorp.com/agent-inject-secret-mariadb-credentials: "secret/data/oracle-nats-publisher/mariadb"
    vault.hashicorp.com/agent-inject-template-mariadb-credentials: |
      {{- with secret "secret/data/oracle-nats-publisher/mariadb" -}}
      export MARIADB_HOST="{{ .Data.data.host }}"
      export MARIADB_PORT="{{ .Data.data.port }}"
      export MARIADB_DATABASE="{{ .Data.data.database }}"
      export MARIADB_USER="{{ .Data.data.username }}"
      export MARIADB_PASSWORD="{{ .Data.data.password }}"
      {{- end -}}

    # NATS credentials (if authentication is enabled)
    vault.hashicorp.com/agent-inject-secret-nats-credentials: "secret/data/oracle-nats-publisher/nats"
    vault.hashicorp.com/agent-inject-template-nats-credentials: |
      {{- with secret "secret/data/oracle-nats-publisher/nats" -}}
      export NATS_USER="{{ .Data.data.username }}"
      export NATS_PASSWORD="{{ .Data.data.password }}"
      {{- end -}}
